<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="3.5" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <Import Project="$(MSBuildExtensionsPath)\ExtensionPack\MSBuild.ExtensionPack.tasks"/>
    <Target Name="Default" DependsOnTargets="BuildFMExcelAddInWrapper"/>
    <Target Name="BuildFMExcelAddInWrapper">
	<MSBuild.ExtensionPack.Framework.TextString TaskAction="Replace" OldString="$(VersionString)" OldValue="." NewValue=",">
            <Output PropertyName="VersionStringReplace" TaskParameter="NewString"/>
        </MSBuild.ExtensionPack.Framework.TextString>

	<FileSystem.File TaskAction="Replace" Files="..\FMExcelAddin\UserTools\Planing\ExcelAddIn\VersionInfo.rc" RegexPattern="FILEVERSION\s+\S+" Replacement="FILEVERSION $(VersionStringReplace)" TextEncoding="windows-1251"/>
	<FileSystem.File TaskAction="Replace" Files="...\FMExcelAddin\UserTools\Planing\DefattedPlaningProvider\VersionInfo.rc" RegexPattern="FILEVERSION\s+\S+" Replacement="FILEVERSION $(VersionStringReplace)" TextEncoding="windows-1251" />
	<FileSystem.File TaskAction="Replace" Files="..\FMExcelAddin\UserTools\Planing\PlaningTools\VersionInfo.rc" RegexPattern="FILEVERSION\s+\S+" Replacement="FILEVERSION $(VersionStringReplace)" TextEncoding="windows-1251" />
	
	<Exec Command="rmdir /S /Q ..\output\" IgnoreExitCode="True" /> 

	<Exec Command="MD ..\output" IgnoreExitCode="True" />
	<Exec Command="MD ..\output\dcu" IgnoreExitCode="True" />
	<Exec Command="MD ..\output\Bin" IgnoreExitCode="True" />
	
	<MSBuild.ExtensionPack.Framework.CommandLine
      		Command="&quot;$(myDir)\FMExcelAddin\FMExcelAddinCompile.bat&quot; &quot;$(myDir)&quot;"
      		CustomErrorRegularExpression="((?&lt;File&gt;.*)(?&lt;ErrorCode&gt;\(\d+\))\s*Fatal:\s*(?&lt;Message&gt;.*))|((?&lt;File&gt;.*)(?&lt;ErrorCode&gt;\(\d+\))\s*Error:\s*(?&lt;Message&gt;.*))"
		CustomWarningRegularExpression="((?&lt;File&gt;.*)(?&lt;ErrorCode&gt;\(\d+\))\s*Warning:\s*(?&lt;Message&gt;.*))|(Warning:\s*(?&lt;Message&gt;.*))"
      		ContinueOnError="false"
		IgnoreStandardErrorWarningFormat="true" />

	<Exec Command="xcopy /EI ..\output\Bin Krista.FM.OfficeAddIn-$(VersionString)"/>
	<Exec Command="zip -mr ..\output\Krista.FM.OfficeAddIn-$(VersionString).zip Krista.FM.OfficeAddIn-$(VersionString)*"/>
	<Exec Command="rmdir /S /Q ..\output\Bin" IgnoreExitCode="True"/>
	<Exec Command="rmdir /S /Q ..\output\dcu" IgnoreExitCode="True"/>
  </Target>
</Project>