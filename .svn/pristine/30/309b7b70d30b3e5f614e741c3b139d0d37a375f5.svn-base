CALCULATE;

//Период__Период
/*SCOPE([Период__Период].[Период__Период].[Квартал].members);
    this = Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not (Measures.CurrentMember = 0)), 1).Item(0);
END SCOPE;

SCOPE([Период__Период].[Период__Период].[Полугодие].members);
    this = Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not (Measures.CurrentMember = 0)), 1).Item(0);
END SCOPE;
*/
SCOPE([Период__Период].[Период__Период].[Год].members);
    this = IIF (not IsEmpty(([Measures].[Значение],[Период__Период].[Период__Период].CurrentMember)),
Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not (Measures.CurrentMember = 0)), 1).Item(0), null);
END SCOPE;

//Вычисляемые меры
CREATE MEMBER CURRENTCUBE.Measures.[Значение за период] AS 
IIF(IsEmpty(([Период__Период].[Период__Период].CurrentMember,[Measures].[Значение С начала года])), null,
IIF([Период__Период].[Период__Период].CurrentMember.Level.Name = "Месяц", 
IIF(not IsEmpty((Tail(Filter({[Период__Период].[Период__Период].CurrentMember.PrevMember.FirstSibling:[Период__Период].[Период__Период].CurrentMember.PrevMember}, 
not IsEmpty([Measures].[Значение С начала года]))).Item(0),[Measures].[Значение С начала года]))and 
Ancestor(Tail(Filter({[Период__Период].[Период__Период].CurrentMember.PrevMember.FirstSibling:[Период__Период].[Период__Период].CurrentMember.PrevMember}, 
not IsEmpty([Measures].[Значение С начала года]))).Item(0), [Период__Период].[Период__Период].[Год])
 = Ancestor([Период__Период].[Период__Период].CurrentMember, [Период__Период].[Период__Период].[Год]),
([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember) -  (Tail(Filter({[Период__Период].[Период__Период].CurrentMember.PrevMember.FirstSibling:[Период__Период].[Период__Период].CurrentMember.PrevMember}, 
not IsEmpty([Measures].[Значение С начала года]))).Item(0),[Measures].[Значение С начала года]),

IIF(not IsEmpty((Tail(Filter({[Период__Период].[Период__Период].CurrentMember.PrevMember.Parent.PrevMember.FirstSibling:[Период__Период].[Период__Период].CurrentMember.Parent.PrevMember}, 
not IsEmpty([Measures].[Значение С начала года]))).Item(0),[Measures].[Значение С начала года]))and 
Ancestor(Tail(Filter({[Период__Период].[Период__Период].CurrentMember.PrevMember.Parent.PrevMember.FirstSibling:[Период__Период].[Период__Период].CurrentMember.Parent.PrevMember}, 
not IsEmpty([Measures].[Значение С начала года]))).Item(0), [Период__Период].[Период__Период].[Год])
 = Ancestor([Период__Период].[Период__Период].CurrentMember, [Период__Период].[Период__Период].[Год]),
([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember) - 
(Tail(Filter({[Период__Период].[Период__Период].CurrentMember.PrevMember.Parent.PrevMember.FirstSibling:[Период__Период].[Период__Период].CurrentMember.Parent.PrevMember}, 
not IsEmpty([Measures].[Значение С начала года]))).Item(0),[Measures].[Значение С начала года]),

IIF(not IsEmpty((Tail(Filter({[Период__Период].[Период__Период].CurrentMember.PrevMember.Parent.Parent.PrevMember.FirstSibling:[Период__Период].[Период__Период].CurrentMember.Parent.Parent.PrevMember}, 
not IsEmpty([Measures].[Значение С начала года]))).Item(0),[Measures].[Значение С начала года]))and 
Ancestor(Tail(Filter({[Период__Период].[Период__Период].CurrentMember.PrevMember.Parent.Parent.PrevMember.FirstSibling:[Период__Период].[Период__Период].CurrentMember.Parent.Parent.PrevMember}, 
not IsEmpty([Measures].[Значение С начала года]))).Item(0), [Период__Период].[Период__Период].[Год])
 = Ancestor([Период__Период].[Период__Период].CurrentMember, [Период__Период].[Период__Период].[Год]),
([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember) - 
(Tail(Filter({[Период__Период].[Период__Период].CurrentMember.PrevMember.Parent.Parent.PrevMember.FirstSibling:[Период__Период].[Период__Период].CurrentMember.Parent.Parent.PrevMember}, 
not IsEmpty([Measures].[Значение С начала года]))).Item(0),[Measures].[Значение С начала года]),

([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember)))),
([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember)))
, 
FORMAT_STRING = "Currency", 
VISIBLE = 1  ;

SCOPE(Measures.[Значение за период]); 
    this = 
IIF([Период__Период].[Период__Период].CurrentMember.Level.Name = "Квартал" or 
[Период__Период].[Период__Период].CurrentMember.Level.Name = "Полугодие",
 sum([Период__Период].[Период__Период].CurrentMember.Children, [Measures].CurrentMember),
([Период__Период].[Период__Период].CurrentMember, [Measures].CurrentMember)); 
END SCOPE;

/*
SCOPE([Measures].[Значение с начала года]);
   this = IIF(not IsLeaf([Период__Период].[Период__Период].CurrentMember), 
   IIF([Период__Период].[Период__Период].CurrentMember is [Период__Период].[Период__Период].[Данные всех периодов], Sum([Период__Период].[Период__Период].[Данные всех периодов].Children), Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not IsEmpty([Measures].CurrentMember)),1).Item(0)), [Период__Период].[Период__Период].CurrentMember);
END SCOPE;*/

/*
CALCULATE;

//Период__Период
/*SCOPE([Период__Период].[Период__Период].[Квартал].members);
    this = Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not (Measures.CurrentMember = 0)), 1).Item(0);
END SCOPE;

SCOPE([Период__Период].[Период__Период].[Полугодие].members);
    this = Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not (Measures.CurrentMember = 0)), 1).Item(0);
END SCOPE;
*/
SCOPE([Период__Период].[Период__Период].[Год].members);
    this = IIF (not IsEmpty(([Measures].[Значение],[Период__Период].[Период__Период].CurrentMember)),
Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not (Measures.CurrentMember = 0)), 1).Item(0), null);
END SCOPE;

//Вычисляемые меры

CREATE MEMBER CURRENTCUBE.Measures.[Значение за период] AS IIF(IsEmpty(([Measures].[Значение с начала года], [Период__Период].[Период__Период].CurrentMember)),
null,
IIF([Период__Период].[Период__Период].CurrentMember.Level.Name = "Месяц", 
IIF([Период__Период].[Период__Период].CurrentMember.Name = "Январь", ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember),
/*IIF([Период__Период].[Период__Период].CurrentMember.Level.Name = "Год" or [Период__Период].[Период__Период].CurrentMember.Level.Name = "All" or [Период__Период].[Период__Период].CurrentMember is OpeningPeriod([Период__Период].[Период__Период].CurrentMember.Level, Ancestor([Период__Период].[Период__Период].CurrentMember, [Период__Период].[Период__Период].[Год])),
[Measures].[Значение с начала года],
IIF([Период__Период].[Период__Период].CurrentMember.Name = "Квартал 1", ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember),
IIF([Период__Период].[Период__Период].CurrentMember.Name = "Квартал 2", ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember),*/
IIF(not IsEmpty(([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(1))) and ([Период__Период].[Период__Период].CurrentMember.Lag(1).Name <> "Декабрь"), ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(1)),
IIF(not IsEmpty(([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(2))) and ([Период__Период].[Период__Период].CurrentMember.Lag(2).Name <> "Декабрь"), ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(2)),
IIF(not IsEmpty(([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(3))) and ([Период__Период].[Период__Период].CurrentMember.Lag(3).Name <> "Декабрь"),([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(3)),
IIF(not IsEmpty(([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(4))) and ([Период__Период].[Период__Период].CurrentMember.Lag(4).Name <> "Декабрь"),([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(4)),
IIF(not IsEmpty(([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(5))) and ([Период__Период].[Период__Период].CurrentMember.Lag(5).Name <> "Декабрь"),([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(5)),
IIF(not IsEmpty(([Measures].[Значение С начала года],[Период__Период].[Период__Период].CurrentMember.Lag(6))) and ([Период__Период].[Период__Период].CurrentMember.Lag(6).Name <> "Декабрь"),([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(6)),
IIF(not IsEmpty(([Measures].[Значение С начала года],[Период__Период].[Период__Период].CurrentMember.Lag(6))) and ([Период__Период].[Период__Период].CurrentMember.Lag(9).Name <> "Декабрь"),([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Значение С начала года], [Период__Период].[Период__Период].CurrentMember.Lag(9)),
[Measures].[Значение С начала года])))))))),
 ([Measures].[Значение С начала года],[Период__Период].[Период__Период].CurrentMember)/*Sum([Период__Период].[Период__Период].CurrentMember.Children, [Measures].[Значение За период])*/
)),
FORMAT_STRING = "Currency";
/*
SCOPE([Measures].[Значение с начала года]);
   this = IIF(not IsLeaf([Период__Период].[Период__Период].CurrentMember), 
   IIF([Период__Период].[Период__Период].CurrentMember is [Период__Период].[Период__Период].[Данные всех периодов], Sum([Период__Период].[Период__Период].[Данные всех периодов].Children), Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not IsEmpty([Measures].CurrentMember)),1).Item(0)), [Период__Период].[Период__Период].CurrentMember);
END SCOPE;*/*/