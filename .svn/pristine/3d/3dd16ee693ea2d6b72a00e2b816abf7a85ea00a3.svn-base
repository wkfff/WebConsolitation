<?xml version="1.0" encoding="Windows-1251"?>
<root>	
  <query id="UFK_0017_0001_date">
    <![CDATA[
  with
member Measures.[ДанныеНа] as '[Период].[День].CurrentMember.UniqueName'
select
    {Measures.[ДанныеНа]} on columns,
    {Tail(NonEmptyCrossjoin({[Период].[День].Members}))} on rows
from [УФК_Ведомость по движению свободного остатка]
  ]]>
  </query> 

  <query id="UFK_0017_0002_V">
    <![CDATA[with               
    member Measures.[Общее число дней]       
    as 'Count      
        (
            OpeningPeriod      
            (
                [Период].[День].[День],
                [Период].[День].[Данные всех периодов]      
            ):<%period_day_fo%>      
        )'
    /* Дни берем от искомого в обратном порядке, чтобы найти первый непустой день от текущего.
    Не учитываем дни, когда вообще сумма пустая, это дни, за которые нет данных.
    Меньше 500 рублей считаем пустым, иначе на iPhone округление даст 0, там бывают паразитные суммы */ 
    member Measures.[Число до первого пустого]    
    as 'Count       
        (
            BottomCount        
            (
                Filter        
                (
                    {
                        <%period_day_fo%>:[Период].[День].[Данные всех периодов].[2008].[Полугодие 1].[Квартал 1].[Январь].[1] 
                    },
                    (
                        (
                            [Measures].[Сумма за период],
                            [Межбюджетные трансферты].[УФК_Сопоставимый].CurrentMember        
                        ) < 500 or IsEmpty 
                        (
                            (
                                [Measures].[Сумма за период],
                                [Межбюджетные трансферты].[УФК_Сопоставимый].CurrentMember        
                            )        
                        )        
                    ) and         
                    (
                        [Measures].[Сумма за период],
                        [Межбюджетные трансферты].[УФК_Сопоставимый].[Все]        
                    ) > 0        
                ),
                1        
            ).Item(0):<%period_day_fo%>       
        )'       
    member Measures.[Дней на счете]
    as 'IIF
        (
            Measures.[Общее число дней] = Measures.[Число до первого пустого],
            null,
            Measures.[Число до первого пустого] - 1
        )'
    /* Если средства на счете более 20 рабочих дней - красный индикатор, группа 3. Если больше 10 дней - желтый индикатор, группа 2, иначе зеленый группа 1 */
    member Measures.[Группа]
    as 'IIF(Measures.[Дней на счете] > 19, 3, IIF(Measures.[Дней на счете] > 9, 2, 1))'
select
    {
        [Measures].[Сумма за период],
        Measures.[Дней на счете],
        Measures.[Группа]
    } on columns,
    Order(Filter
    (
        [Межбюджетные трансферты].[УФК_Сопоставимый].[Межбюджетные трансферты2].Members,
        [Measures].[Сумма за период] > 500           
    ), [Measures].[Сумма за период], DESC) on rows
from [УФК_Справка по движению свободного остатка]               
where               
    (
        [Показатели].[УФК_Операции с субсидиями и субвенциями].[Все].[Нераспределенный остаток на конец дня],
        <%period_day_fo%>            
    )
]]>
  </query>

  <query id="UFK_0017_0002">
    <![CDATA[with
    member Measures.[Общее число дней]
    as 'Count
        (
            OpeningPeriod
            (
                [Период].[День].[День],
                [Период].[День].[Данные всех периодов]
            ):<%period_day_fo%>
        )'
    /* Дни берем от искомого в обратном порядке, чтобы найти первый непустой день от текущего.
    Не учитываем дни, когда вообще сумма пустая, это дни, за которые нет данных.
    Меньше 500 рублей считаем пустым, иначе на iPhone округление даст 0, там бывают паразитные суммы */
    member Measures.[Число до первого пустого]
    as 'Count
        (
            BottomCount
            (
                Filter
                (
                    {
                        <%period_day_fo%>:[Период].[День].[Данные всех периодов].[2008].[Полугодие 1].[Квартал 1].[Январь].[1]
                    },
                    (
                        (
                            [Measures].[Сумма за период],
                            [Межбюджетные трансферты].[УФК_Сопоставимый].CurrentMember
                        ) < 500 or IsEmpty
                        (
                            (
                                [Measures].[Сумма за период],
                                [Межбюджетные трансферты].[УФК_Сопоставимый].CurrentMember
                            )
                        )
                    ) and
                    (
                        [Measures].[Сумма за период],
                        [Межбюджетные трансферты].[УФК_Сопоставимый].[Все]
                    ) > 0
                ),
                1
            ).Item(0):<%period_day_fo%>
        )'
    member Measures.[Дней на счете]
    as 'IIF
        (
            Measures.[Общее число дней] = Measures.[Число до первого пустого],
            null,
            Measures.[Число до первого пустого] - 1
        )'
    /* Если средства на счете более 20 рабочих дней - красный индикатор, группа 3. Если больше 10 дней - желтый индикатор, группа 2, иначе зеленый группа 1 */
    member Measures.[Группа]
    as 'IIF(Measures.[Дней на счете] > 19, 3, IIF(Measures.[Дней на счете] > 9, 2, 1))'
select
    {
        [Measures].[Сумма за период],
        Measures.[Дней на счете],
        Measures.[Группа]
    } on columns,
    Order(Filter
    (
        [Межбюджетные трансферты].[УФК_Сопоставимый].[Межбюджетные трансферты2].Members,
        ([Measures].[Сумма за период] > 1000000  and Measures.[Группа] > 1)
    ), Measures.[Дней на счете], DESC) on rows
from [УФК_Справка по движению свободного остатка]
where
    (
        [Показатели].[УФК_Операции с субсидиями и субвенциями].[Все].[Нераспределенный остаток на конец дня],
        <%period_day_fo%>
    )
]]>
  </query>
</root>