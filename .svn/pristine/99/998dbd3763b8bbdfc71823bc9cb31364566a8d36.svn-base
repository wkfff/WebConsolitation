CALCULATE;

//Районы__Сопоставимый
SCOPE([Районы__Сопоставимый].[Районы__Сопоставимый].[Все районы]);
    this = IIF(not IsLeaf([Районы__Сопоставимый].[Районы__Сопоставимый].CurrentMember), 
IIF([Районы__Сопоставимый].[Районы__Сопоставимый].CurrentMember is [Районы__Сопоставимый].[Районы__Сопоставимый].[Все районы], Sum([Районы__Сопоставимый].[Районы__Сопоставимый].[Все районы].Children), 
IIF(not isEmpty([Районы__Сопоставимый].[Районы__Сопоставимый].CurrentMember.DataMember),      [Районы__Сопоставимый].[Районы__Сопоставимый].CurrentMember.DataMember, 0)),
[Районы__Сопоставимый].[Районы__Сопоставимый].CurrentMember);
END SCOPE;

//Вычислимые меры
CREATE MEMBER CURRENTCUBE.Measures.[Соответствие критерию] AS 
IIF(not IsEmpty([Measures].[Количество нарушений]),  IIF(not IsEmpty([Measures].[Значение]) and ([Measures].[Количество нарушений] <> 0), "Не соответствует", IIF(not IsEmpty([Measures].[Значение]) and ([Measures].[Количество нарушений] = 0), "Cоответствует", "")), "");

CREATE MEMBER CURRENTCUBE.Measures.[Пороговое значение] AS 
IIF(IsLeaf([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember), Abs([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].Properties("Пороговое значение")), null);

CREATE MEMBER CURRENTCUBE.Measures.[Темп роста к предыдущему периоду] AS 
IIF(not IsEmpty(([Measures].[Значение], [Период__Период].[Период__Период].CurrentMember)) and ([Период__Период].[Период__Период].PrevMember, [Measures].[Значение]) <> 0, (([Период__Период].[Период__Период].CurrentMember, [Measures].[Значение]) / ([Период__Период].[Период__Период].PrevMember, [Measures].[Значение])),
IIF(IsEmpty(([Measures].[Значение], [Период__Период].[Период__Период].PrevMember)) and not IsEmpty(([Measures].[Значение], [Период__Период].[Период__Период].PrevMember.PrevMember)), (([Период__Период].[Период__Период].CurrentMember, [Measures].[Значение]) / ([Период__Период].[Период__Период].PrevMember.PrevMember, [Measures].[Значение])), null));
/*
CREATE MEMBER CURRENTCUBE.Measures.[Рейтинг] AS 
IIF([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember is [Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].[Данные всех источников], avg([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].[Данные всех источников].children, [Measures].[Значение]), IIF(not IsEmpty(([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember, [Measures].[Значение])), abs([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember.Properties("Максимальное значение")) - ([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember, [Measures].[Значение]),null));
*/
CREATE MEMBER CURRENTCUBE.Measures.[Отклонение от нормативного значения] AS 
IIF(not IsEmpty([Measures].[Значение]), abs(IIF(not IsLeaf([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember), 0, [Measures].[Значение] - abs([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember.Properties("Пороговое значение")))), null);
/*
//Количество нарушений
SCOPE([Measures].[Количество нарушений]);
    this = IIF(([Показатели__БККУ].[Показатели__БККУ].CurrentMember.Name = "НБК") or
([Показатели__БККУ].[Показатели__БККУ].CurrentMember.Name = "НКУ") or
([Показатели__БККУ].[Показатели__БККУ].CurrentMember.Name = "Общее количество нарушений"), 
null,
([Показатели__БККУ].[Показатели__БККУ].CurrentMember, [Measures].[Количество нарушений]));
END SCOPE;

SCOPE([Measures].[Количество нарушений]);
    this = IIF(([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember.Name = "НБК") or ([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember.Name = "НКУ") or ([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember.Name = "Общее количество нарушений"), 
null,
([Показатели__БККУ_Сопоставимый].[Показатели__БККУ_Сопоставимый].CurrentMember, [Measures].[Количество нарушений]));
END SCOPE;
*/