<?xml version="1.0" encoding="Windows-1251"?>
<root>

    <query id="OOS_0001_0002_data">
        <![CDATA[
-- OOS_0001_0002_data
with cte_Territory (ID, Name, RefTerritorialPartType, ParentID, Level)
as
(
	-- Anchor member definition
	select ID, Name, RefTerritorialPartType, ParentID, 0 as Level
    from [DV].[DV].[d_Territory_RF] t
    where t.ID = <%param_territory%>
    union ALL
	-- Recursive member definition    
    select t.ID, t.Name, t.RefTerritorialPartType, t.ParentID, terra.Level + 1
    from 
		[DV].[DV].[d_Territory_RF] t
		inner join cte_Territory terra
			ON t.ParentId = terra.ID    
)
select
	dt.DateDayID as Date, oos_p.RefTypePurch as TypePurchID, oos_lo.Name as BudgetLevel, terra.Name as Terra, 
	oos_org.FullName as Customer, oos_p.Name as Purchase, oos_v.PMP as Price, oos_p.Link as Link,
	oos_p.RefPublicDate, oos_p.RefGiveDate, oos_p.RefConsiderDate, oos_p.RefMatchDate, oos_p.RefResultDate
from 
	cte_Territory terra
	inner join [DV].[DV].[f_OOS_Value] oos_v 
		ON terra.ID = oos_v.RefTerritory 
	inner join [DV].[DV].[d_OOS_Purchase] oos_p
		ON oos_p.ID = oos_v.RefPurchase
	inner join [DV].[DV].[fx_OOS_TypePurch] oos_pt
		ON oos_pt.ID = oos_p.RefTypePurch
	inner join [DV].[DV].[fx_OOS_LevelOrder] oos_lo
		ON oos_lo.ID = oos_v.RefLevelOrder
	inner join [DV].[DV].[d_OOS_Org] oos_org
		ON oos_org.ID = oos_v.RefOrg
	inner join [DV].[DV].[fx_Date_YearDayUNV] dt
		ON dt.ID = oos_p.RefPublicDate
			OR dt.ID = oos_p.RefGiveDate
			OR dt.ID = oos_p.RefConsiderDate
			OR dt.ID = oos_p.RefMatchDate
			OR dt.ID = oos_p.RefResultDate
where 
	terra.Level > 0
	AND	(dt.DateMonthID IN (<%param_date%>))
	AND	(oos_v.RefLevelOrder = 2 OR oos_v.RefLevelOrder = 3)
order by 
	dt.DateDayID ASC, oos_v.PMP DESC
    ]]>
    </query>

    <query id="OOS_0001_0002_data_brief">
        <![CDATA[
-- OOS_0001_0002_data_brief
with cte_Territory (ID, Name, RefTerritorialPartType, ParentID, Level)
as
(
	-- Anchor member definition
	select ID, Name, RefTerritorialPartType, ParentID, 0 as Level
    from [DV].[DV].[d_Territory_RF] t
    where t.ID = <%param_territory%>
    union ALL
	-- Recursive member definition    
    select t.ID, t.Name, t.RefTerritorialPartType, t.ParentID, terra.Level + 1
    from 
		[DV].[DV].[d_Territory_RF] t
		inner join cte_Territory terra
			ON t.ParentId = terra.ID    
)
select
	dt.DateDayID as Date, count(*) as Count, sum(oos_v.PMP) as Price, 
	sum(case when oos_p.RefPublicDate = dt.DateDayID then 1 else 0 end) as PublicCount,
	sum(case when oos_p.RefPublicDate = dt.DateDayID then oos_v.PMP else 0 end) as PublicPrice,
	sum(case when oos_p.RefGiveDate = dt.DateDayID then 1 else 0 end) as GiveCount,
	sum(case when oos_p.RefGiveDate = dt.DateDayID then oos_v.PMP else 0 end) as GivePrice,
	sum(case when oos_p.RefConsiderDate = dt.DateDayID then 1 else 0 end) as ConsiderCount,
	sum(case when oos_p.RefConsiderDate = dt.DateDayID then oos_v.PMP else 0 end) as ConsiderPrice,
	sum(case when oos_p.RefMatchDate = dt.DateDayID OR oos_p.RefResultDate = dt.DateDayID then 1 else 0 end) as ResultCount,
	sum(case when oos_p.RefMatchDate = dt.DateDayID OR oos_p.RefResultDate = dt.DateDayID then oos_v.PMP else 0 end) as ResultPrice
from 
	cte_Territory terra
	inner join [DV].[DV].[f_OOS_Value] oos_v 
		ON terra.ID = oos_v.RefTerritory 
	inner join [DV].[DV].[d_OOS_Purchase] oos_p
		ON oos_p.ID = oos_v.RefPurchase			
	inner join [DV].[DV].[fx_Date_YearDayUNV] dt
		ON dt.ID = oos_p.RefPublicDate
			OR dt.ID = oos_p.RefGiveDate
			OR dt.ID = oos_p.RefConsiderDate
			OR dt.ID = oos_p.RefMatchDate
			OR dt.ID = oos_p.RefResultDate
where 
	terra.Level > 0
	AND	(dt.DateMonthID IN (<%param_date%>))
	AND	(oos_v.RefLevelOrder = 2 OR oos_v.RefLevelOrder = 3)
group by
	dt.DateDayID
order by 
	dt.DateDayID ASC
    ]]>
    </query> 
    
</root>
