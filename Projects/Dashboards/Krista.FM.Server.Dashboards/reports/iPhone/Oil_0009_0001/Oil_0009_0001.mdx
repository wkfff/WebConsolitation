<?xml version="1.0" encoding="Windows-1251"?>
<root>
  <query id="Oil_0009_0001_lastDate">
    <![CDATA[
    --Oil_0009_0001_lastDate
with
    member Measures.[ДанныеНа]
    as '[Период__Период].[Период__Период].CurrentMember.UniqueName'
select
    {Measures.[ДанныеНа]} on columns,
    Tail
    (
        Filter
        (
            OpeningPeriod
            (
                [Период__Период].[Период__Период].[День],
                [Период__Период].[Период__Период].[Данные всех периодов].[2008]
            ) : ClosingPeriod
            (
                [Период__Период].[Период__Период].[День],
                [Период__Период].[Период__Период].[Данные всех периодов].[2012]
            ),
            not IsEmpty([Measures].[Розничная цена])
        ),
        2
    ) on rows
from [Организации_Цены на ГСМ]
  ]]>
  </query>

  <query id="Oil_0009_0001_chart">
    <![CDATA[
    --Oil_0009_0001_chart
with 
    set [Территории] 
    as 'Generate
        (
            Filter 
            (
                {[Территории__РФ].[Территории__РФ].[Все территории].[Российская Федерация].[Уральский федеральный округ].[Тюменская область с Ханты-Мансийским автономным округом, Ямало-Ненецким автономным округом].[Ханты-Мансийский автономный округ - Югра]} +
                Descendants 
                (
                    [Территории__РФ].[Территории__РФ].[Все территории].[Российская Федерация].[Уральский федеральный округ].[Тюменская область с Ханты-Мансийским автономным округом, Ямало-Ненецким автономным округом].[Ханты-Мансийский автономный округ - Югра],
                    [Территории__РФ].[Территории__РФ].[МР ГО],
                    SELF 
                ),
                [Территории__РФ].[Территории__РФ].CurrentMember.Name = "<%selected_subject%>"
            ),
            Filter 
            (
                Descendants 
                (
                    [Территории__РФ].[Территории__РФ].CurrentMember,
                    [Территории__РФ].[Территории__РФ].[МР ГО],
                    SELF 
                ),
                not 
                (
                    [Территории__РФ].[Территории__РФ].CurrentMember is [Территории__РФ].[Территории__РФ].CurrentMember.Parent.DataMember
                ) 
            )
        )' 

    set [Территории ХМАО] 
    as 'Filter 
        (
            Descendants 
            (
                [Территории__РФ].[Территории__РФ].[Все территории].[Российская Федерация].[Уральский федеральный округ].[Тюменская область с Ханты-Мансийским автономным округом, Ямало-Ненецким автономным округом].[Ханты-Мансийский автономный округ - Югра],
                [Территории__РФ].[Территории__РФ].[МР ГО],
                SELF 
            ),
            not 
            (
                [Территории__РФ].[Территории__РФ].CurrentMember is [Территории__РФ].[Территории__РФ].CurrentMember.Parent.DataMember
            ) 
        )'         
    set [Организации] 
    as 'Descendants 
        (
            [Организации__АЗС].[Организации__АЗС].[Все].[ОРГАНИЗАЦИИ Цены на ГСМ],
            [Организации__АЗС].[Организации__АЗС].[АЗС],
            SELF 
        )' 
    member [Measures].[На прошлую дату] 
    as 'Round 
        (
           (
             [Measures].[Розничная цена],
             <%period_last_date%>
           ),
           2
        ) - [Measures].[Снижение]' 
    member [Measures].[На текущую дату] 
    as 'Round 
        (
          (
            [Measures].[Розничная цена],
            <%period_cur_date%>
          ),
          2
        )' 
    member [Measures].[Отклонение] 
    as 'IIF 
        (
            IsEmpty 
            (
                (
                    [Measures].[Розничная цена],
                    <%period_last_date%>
                ) 
            ),
            null,
            [Measures].[На текущую дату] - 
            Round
            (
                (
                  [Measures].[Розничная цена],
                  <%period_last_date%>
                ),
                2
            )
        )' 
    member [Measures].[Прирост] 
    as 'IIF 
        (
            [Measures].[Отклонение] > 0,
            [Measures].[Отклонение],
            0 
        )' 
    member [Measures].[Снижение] 
    as 'IIF 
        (
            [Measures].[Отклонение] < 0,
            -[Measures].[Отклонение],
            0 
        )' 
    member [Measures].[Наименование] 
    as '[Организации__АЗС].[Организации__АЗС].CurrentMember.Name'  
    member [Measures].[Предел] 
    as 'Round
        (
          (
              [Measures].[Розничная цена],
              <%period_last_year%>
          ),
          2
        )  ' 
        
    member [Организации__Виды ГСМ].[Организации__Виды ГСМ].[ДТ] 
    as '[Организации__Виды ГСМ].[Организации__Виды ГСМ].[Все].[ОРГАНИЗАЦИИ Цены на ГСМ].[Дизельное топливо]'
        
    member [Организации__АЗС].[Организации__АЗС].[ХМАО]
    as 'AVG({[Территории ХМАО] * [Организации]} )'

select
    {
        [Measures].[Наименование],
        [Measures].[На прошлую дату],
        [Measures].[Прирост],
        [Measures].[Снижение] 
    } on columns,
    {
        {
            [Территории__РФ].[Территории__РФ].[Все территории]
        }
        * 
        {
            [Организации__АЗС].[Организации__АЗС].[ХМАО]
        }
    } +
    Head
    (
     Filter 
        (
            {[Территории] * [Организации]},
            not IsEmpty([Measures].[На текущую дату]) and ([Measures].[На прошлую дату] <> 0) and 
            (
                [Measures].[Прирост] > 0 or [Measures].[Снижение] > 0 or 
                (
                    [Measures].[На текущую дату] > [Measures].[Предел] and [Measures].[Предел] <> 0 
                ) 
            ) 
        ), 
       70
      ) on rows 
from [Организации_Цены на ГСМ] 
where 
    (
        [Организации__Виды ГСМ].[Организации__Виды ГСМ].[<%oil_shortName%>]
    ) 
  ]]>
  </query>

  <query id="Oil_0009_0001_avg">
    <![CDATA[
    --Oil_0009_0001_avg
with
    set [Территории] 
    as 'Filter 
        (
            Descendants 
            (
                [Территории__РФ].[Территории__РФ].[Все территории].[Российская Федерация].[Уральский федеральный округ].[Тюменская область с Ханты-Мансийским автономным округом, Ямало-Ненецким автономным округом].[Ханты-Мансийский автономный округ - Югра],
                [Территории__РФ].[Территории__РФ].[МР ГО],
                SELF 
            ),
            not 
            (
                [Территории__РФ].[Территории__РФ].CurrentMember is [Территории__РФ].[Территории__РФ].CurrentMember.Parent.DataMember
            ) 
        )'    
        
    set [Организации]
    as 'Descendants
        (
            [Организации__АЗС].[Организации__АЗС].[Все].[ОРГАНИЗАЦИИ Цены на ГСМ],
            [Организации__АЗС].[Организации__АЗС].[АЗС],
            SELF
        )'

    member [Measures].[На текущую дату]
    as '
        (
            [Measures].[Розничная цена],
            <%period_cur_date%>
        )'
        
    member [Measures].[Среднее]
    as 'AVG({[Территории] * [Организации]}, [Measures].[На текущую дату])'

    member [Организации__Виды ГСМ].[Организации__Виды ГСМ].[ДТ] 
    as '[Организации__Виды ГСМ].[Организации__Виды ГСМ].[Все].[ОРГАНИЗАЦИИ Цены на ГСМ].[Дизельное топливо]'
    
select
    {
        [Measures].[Среднее]
    } on columns
from  [Организации_Цены на ГСМ]
where
    (
        [Организации__Виды ГСМ].[Организации__Виды ГСМ].[<%oil_shortName%>]
    )
  ]]>
  </query>

  <query id="Oil_0009_0001_limit">
    <![CDATA[
    --Oil_0009_0001_limit
with
    set [Территории] 
    as 'Generate
        (
            Filter 
            (
                {[Территории__РФ].[Территории__РФ].[Все территории].[Российская Федерация].[Уральский федеральный округ].[Тюменская область с Ханты-Мансийским автономным округом, Ямало-Ненецким автономным округом].[Ханты-Мансийский автономный округ - Югра]} +
                Descendants 
                (
                    [Территории__РФ].[Территории__РФ].[Все территории].[Российская Федерация].[Уральский федеральный округ].[Тюменская область с Ханты-Мансийским автономным округом, Ямало-Ненецким автономным округом].[Ханты-Мансийский автономный округ - Югра],
                    [Территории__РФ].[Территории__РФ].[МР ГО],
                    SELF 
                ),
                [Территории__РФ].[Территории__РФ].CurrentMember.Name = "<%selected_subject%>"
            ),
            Filter 
            (
                Descendants 
                (
                    [Территории__РФ].[Территории__РФ].CurrentMember,
                    [Территории__РФ].[Территории__РФ].[МР ГО],
                    SELF 
                ),
                not 
                (
                    [Территории__РФ].[Территории__РФ].CurrentMember is [Территории__РФ].[Территории__РФ].CurrentMember.Parent.DataMember
                ) 
            )
        )'
    set [Территории ХМАО] 
    as 'Filter 
        (
            Descendants 
            (
                [Территории__РФ].[Территории__РФ].[Все территории].[Российская Федерация].[Уральский федеральный округ].[Тюменская область с Ханты-Мансийским автономным округом, Ямало-Ненецким автономным округом].[Ханты-Мансийский автономный округ - Югра],
                [Территории__РФ].[Территории__РФ].[МР ГО],
                SELF 
            ),
            not 
            (
                [Территории__РФ].[Территории__РФ].CurrentMember is [Территории__РФ].[Территории__РФ].CurrentMember.Parent.DataMember
            ) 
        )'         
    set [Организации]
    as 'Descendants
        (
            [Организации__АЗС].[Организации__АЗС].[Все].[ОРГАНИЗАЦИИ Цены на ГСМ],
            [Организации__АЗС].[Организации__АЗС].[АЗС],
            SELF
        )'

    member [Measures].[Предел]
    as '
        (
            [Measures].[Розничная цена],
            <%period_last_year%>
        )'

    member [Организации__Виды ГСМ].[Организации__Виды ГСМ].[ДТ] 
    as '[Организации__Виды ГСМ].[Организации__Виды ГСМ].[Все].[ОРГАНИЗАЦИИ Цены на ГСМ].[Дизельное топливо]'
    
    member [Measures].[Наименование] 
    as '[Организации__АЗС].[Организации__АЗС].CurrentMember.Name'      
    
    member [Организации__АЗС].[Организации__АЗС].[ХМАО]
    as 'AVG({[Территории ХМАО] * [Организации]})'
    
select
    {  [Measures].[Наименование], [Measures].[Предел] } on columns,
    non empty 
    {
       {
            {
                [Территории__РФ].[Территории__РФ].[Все территории]
            }
            * 
            {
                [Организации__АЗС].[Организации__АЗС].[ХМАО]
            }
        } +
       {[Территории] * [Организации]} 
    } on rows
from [Организации_Цены на ГСМ]
where
    (
        [Организации__Виды ГСМ].[Организации__Виды ГСМ].[<%oil_shortName%>]
    ) 
  ]]>
  </query>
  
</root>