CALCULATE;



CREATE MEMBER CURRENTCUBE.Measures.[Сумма с начала года] AS
IIF (not IsEmpty(Measures.[ПоследМесяц]),
  (StrToMember("[Период__Период].[Период__Период].&["+ Cstr([Measures].[ПоследМесяц]) +"]"),[Measures].[Сумма_с начала года]),
  null),
FORMAT_STRING = "Currency", NON_EMPTY_BEHAVIOR = {Measures.[Сумма_с начала года]}, VISIBLE = 1;  


CREATE MEMBER CURRENTCUBE.Measures.[Сумма за период] AS
IIF(IsEmpty(([Период__Период].[Период__Период].CurrentMember, [Measures].[Сумма с начала года])), null, 
IIF([Период__Период].[Период__Период].CurrentMember.Level is  [Период__Период].[Период__Период].[Год] or
[Период__Период].[Период__Период].CurrentMember.Name = "Полугодие 1" or 
[Период__Период].[Период__Период].CurrentMember.Name = "Квартал 1",
([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember),

IIF([Период__Период].[Период__Период].CurrentMember.name = "Апрель" or [Период__Период].[Период__Период].CurrentMember.name = "Октябрь", ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember.PrevMember.PrevMember),
IIF([Период__Период].[Период__Период].CurrentMember.name = "Июль", ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember.PrevMember.PrevMember.PrevMember),

IIF(not IsEmpty([Период__Период].[Период__Период].CurrentMember.PrevMember), ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember.PrevMember),
IIF(not IsEmpty([Период__Период].[Период__Период].CurrentMember.PrevMember.PrevMember), ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember.PrevMember.PrevMember),
IIF(not IsEmpty([Период__Период].[Период__Период].CurrentMember.PrevMember.PrevMember.PrevMember), ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember.PrevMember.PrevMember.PrevMember),
([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember) - ([Measures].[Сумма с начала года], [Период__Период].[Период__Период].CurrentMember.PrevMember)
))))))),
FORMAT_STRING = "Currency", NON_EMPTY_BEHAVIOR = {Measures.[Сумма_с начала года]}, VISIBLE = 1; 

/*
/* 1. Определяю значения меры Нарастающий итог на уровне Дата */
([Measures].[Сумма_с начала года],{[Период__Период].[Период__Период].[День].Members}) =

/* если данные поступают за период */
IIF((not IsEmpty(([Measures].[За период]))) and (([Measures].[Сумма_с начала года]) = 0 or IsEmpty(([Measures].[Сумма_с начала года]))),
/* то определяем меру Нарастающий итог, как сумму по уровню Дата с начала года по текущий элемент включительно */
Sum(TopCount(DESCENDANTS(Ancestor([Период__Период].[Период__Период].CurrentMember,[Период__Период].[Период__Период].[Год]),[Период__Период].[Период__Период].[День],SELF),1).Item(0):[Период__Период].[Период__Период].CurrentMember,[Measures].[За период]),
/* иначе ничего с мерой За период не делаю, т.е. данные идут нарастающим итогом */
([Measures].[Сумма_с начала года]));

/* 2. Замораживаем меру Нарастающий итог на уровне Дата, т.к. дальше будем менять меру За период, на основе которой идет верхний расчет
чтобы не уйти в рекурсию */
FREEZE (([Measures].[Сумма_с начала года],{[Период__Период].[Период__Период].[День].Members}));

/* 3. Определяю значения меры За период на уровне Дата */
([Measures].[За период],{[Период__Период].[Период__Период].[День].Members}) =
/* если есть данные нарастающим итогом, но нет данных за период, т.е. нарастающий итог введен, а не получен в результате расчета */
IIF((not IsEmpty(([Measures].[Сумма_с начала года]))) and (([Measures].[За период]) = 0),
/* то определяю меру За период как разницу между текущим значением и последним непустым с начала текущего года */
([Период__Период].[Период__Период].CurrentMember,[Measures].[Сумма_с начала года])
- (Tail(Filter(
TopCount(DESCENDANTS(Ancestor([Период__Период].[Период__Период].CurrentMember,[Период__Период].[Период__Период].[Год]),[Период__Период].[Период__Период].[День],SELF),1).Item(0):[Период__Период].[Период__Период].CurrentMember.PrevMember
, not IsEmpty([Measures].[Сумма_с начала года]))).Item(0),[Measures].[Сумма_с начала года]),
/* иначе ничего с мерой Нарастающий итог не делаю, т.е. данные идут за период */
([Measures].[За период]));

CREATE MEMBER CURRENTCUBE.Measures.[Сумма с начала года] AS
IIF (not IsEmpty(Measures.[ПоследМесяц]),
  (StrToMember("[Период__Период].[Период__Период].&["+ Cstr([Measures].[ПоследМесяц]) +"]"),[Measures].[Сумма_с начала года]),
  null),
FORMAT_STRING = "Currency", VISIBLE = 1; 

/*
/* 4. Переопределяю итоги меры Нарастающий итог */
/* на уровне Месяц */
([Measures].[Сумма_с начала года],{[Период__Период].[Период__Период].[Месяц].Members}) =
([Measures].[Сумма_с начала года],
Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not IsEmpty([Measures].[Сумма_с начала года]))).Item(0));
/* На уровне Квартал */
([Measures].[Сумма_с начала года],{[Период__Период].[Период__Период].[Квартал].Members}) =
([Measures].[Сумма_с начала года],
Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not IsEmpty([Measures].[Сумма_с начала года]))).Item(0));
/* на уровне Полугодие */
([Measures].[Сумма_с начала года],{[Период__Период].[Период__Период].[Полугодие].Members}) =
([Measures].[Сумма_с начала года],
Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not IsEmpty([Measures].[Сумма_с начала года]))).Item(0));
/* на уровне Год */
([Measures].[Сумма_с начала года],{[Период__Период].[Период__Период].[Год].Members}) =
([Measures].[Сумма_с начала года],
Tail(Filter([Период__Период].[Период__Период].CurrentMember.Children, not IsEmpty([Measures].[Сумма_с начала года]))).Item(0));
*/
*/
