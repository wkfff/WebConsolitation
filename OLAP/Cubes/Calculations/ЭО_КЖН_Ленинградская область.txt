CALCULATE;

/* Мера - Оценка. Обнуляю, т.к. на уровне Показатели она должна быть пустой */
({[Measures].[Оценка]},{[КЖН__Ленинградская область].[КЖН__Ленинградская область].[Показатель].MEMBERS}) = null;

/* Мера - Вспомогательная. На уровне Показатели определяю взвешанные темпы роста 
 Частные индикаторы получаются как сумма взвешенных значений автоматически */
({[Measures].[Вспом]},{[КЖН__Ленинградская область].[КЖН__Ленинградская область].[Показатель].MEMBERS}) =
IIF(Val([КЖН__Ленинградская область].[КЖН__Ленинградская область].CurrentMember.Properties("Флаг")) = 0,
  IIF(([Период__Год].[Период__Год].CurrentMember.PrevMember,[Measures].[Значение])<>0,
    ([Период__Год].[Период__Год].CurrentMember,[Measures].[Значение])/([Период__Год].[Период__Год].CurrentMember.PrevMember,[Measures].[Значение])
    * [КЖН__Ленинградская область].[КЖН__Ленинградская область].CurrentMember.Properties("Весовой коэффициент", typed),
    null),
  IIF(([Период__Год].[Период__Год].CurrentMember,[Measures].[Значение])<>0,
    ([Период__Год].[Период__Год].CurrentMember.PrevMember,[Measures].[Значение])/([Период__Год].[Период__Год].CurrentMember,[Measures].[Значение])
    * [КЖН__Ленинградская область].[КЖН__Ленинградская область].CurrentMember.Properties("Весовой коэффициент", typed),
    null));

/* Мера - Оценка. Формирую уровень Частный индикатор как взвешанные суммы аналогичного уровня вспомогательной меры */
({[Measures].[Оценка]},{[КЖН__Ленинградская область].[КЖН__Ленинградская область].[Частный индикатор].MEMBERS}) =
([Measures].[Вспом],[КЖН__Ленинградская область].[КЖН__Ленинградская область].CurrentMember);

/* Мера - Оценка. Замораживаю значения уровня Частный индикатор, чтобы они не изменились при дальнейших изменениях 
вспомогательной меры для этого же уровня */
FREEZE(({[Measures].[Оценка]},{[КЖН__Ленинградская область].[КЖН__Ленинградская область].[Частный индикатор].MEMBERS}));

/* ВНИМАНИЕ - рекурсия. Переопределяю вспомогательную меру для уровня Частный индикатор - домножаю на вес
 Интегральный показатель получается как сумма взвешенных значений автоматически */
({[Measures].[Вспом]},{[КЖН__Ленинградская область].[КЖН__Ленинградская область].[Частный индикатор].MEMBERS}) =
([КЖН__Ленинградская область].[КЖН__Ленинградская область].CurrentMember,[Measures].[Вспом])
* [КЖН__Ленинградская область].[КЖН__Ленинградская область].CurrentMember.Properties("Весовой коэффициент", typed);

/* Мера - Оценка. Формирую Интегральный показатель как аналогичный показатель вспомогательной меры */
([Measures].[Оценка],[КЖН__Ленинградская область].[КЖН__Ленинградская область].[Интегральный показатель]) =
([Measures].[Вспом],[КЖН__Ленинградская область].[КЖН__Ленинградская область].[Интегральный показатель]);

/* Мера - Оценка. Накладываю форматирование */
FORMAT_STRING([Measures].[Оценка])= '0.0000';
